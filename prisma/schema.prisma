// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String          @id @default(cuid())
  name          String?
  email         String          @unique
  emailVerified DateTime?
  image         String?
  googleId      String?
  password      String?          @unique
  accounts      Account[]
  sessions      Session[]
  // Optional for WebAuthn support
  Authenticator Authenticator[]

  tier          Tier @default(FREE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userCharacters UserCharacter[] // Relation to the UserCharacter model
}

enum Tier {
  FREE
  SILVER
  GOLD
  PLATINUM
}

model Character {
  id           Int        @id @default(autoincrement())
  name         String
  description  String?
  tags         Tag[]      @relation("CharacterTags") // A character can have multiple tags
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  personaData   Persona?   @relation(fields: [personaId], references: [id])
  personaId     Int?       @unique // Foreign key reference to Persona
  userCharacters UserCharacter[]
}

model Persona {
  id            Int       @id @default(autoincrement())
  age           String?
  gender        String?
  nationality   String?
  sexuality     String?
  height        String?
  species       String?
  occupation    String?
  affiliation   String?
  mind          String?
  personality   String?
  appearance    String?
  clothes       String?
  attributes    String?
  likes         String?
  dislikes      String?
  description   String?
  character     Character? @relation // Optional relation to UserCharacter
}

model UserCharacter {
  id            Int        @id @default(autoincrement())
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String

  character     Character  @relation(fields: [characterId], references: [id], onDelete: Cascade)
  characterId   Int

  version       Int        @default(1) // Version number for the unique copy of the character

  chatHistory   String[]   // Array of strings to store user-specific chat history for this character version

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@unique([userId, characterId, version]) // Ensure that a unique version exists per user and character
}

model Tag {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  characters  Character[] @relation("CharacterTags") // A tag can relate to many characters
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// Optional for WebAuthn support
model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}
